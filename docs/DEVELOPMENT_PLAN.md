# 開発計画

## 1. 現在の状況

**→ Phase 1 準備完了（リポジトリ作成済み）**

### 完了
- [x] 要件定義
- [x] 文書構成確定
- [x] 全文書作成
- [x] AI設計（複数プロバイダー対応）
- [x] 開発環境設計（uv + ruff + pre-commit）
- [x] GitHubリポジトリ作成
- [x] 初期ファイル配置

### 次のアクション
- [x] Issue #1 起票・実装完了（2025-01-01）
- [x] Issue #2 Discord Bot基盤完了（2025-01-04）
- [x] Issue #3 メッセージ＋添付ファイル保存完了（2025-01-04）※#4と統合
- [x] Issue #5 Workspace/Room分離完了（2025-01-04）※実機テストは#14で実施
- [x] Issue #7 AI基盤完了（2025-01-05）

## 2. 開発方針

- テスト駆動開発（TDD）
- GitHub Issue駆動
- 1 Issue = 1 PR = 1 機能
- Claude Codeで実装補助
- 9つの専門家視点でレビュー

## 3. Phase 1 詳細スケジュール

### Week 1: 基盤構築

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #1 | DB設計・実装 | models.py、テスト通過 | ✅完了 |
| #2 | Discord Bot基盤 | 接続確認、イベント受信 | ✅完了 |
| #3 | メッセージ＋添付ファイル保存 | テスト通過、手動テスト成功 | ✅完了（#4統合） |

### Week 2: Bot機能

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #4 | 添付ファイル保存 | 写真・動画保存成功 | ✅完了（#3に統合） |
| #5 | Workspace/Room分離 | 構造通りに分離確認 | ✅完了（※1） |
| #6 | ローカルストレージ | ファイル保存・取得 | ✅完了（#3に統合） |

> **※1 Issue #5 注記**: ユニットテストで分離は確認済み。実機テスト（複数Discordサーバー）は Issue #14（試験運用準備）で実施予定。手戻りリスクは低いと評価（分離ロジックが単純、DBで強制分離）。

### Week 3: AI連携

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #7 | AI基盤（base, router） | 抽象化レイヤー完成 | ✅完了 |
| #8 | OpenAIプロバイダー | 接続・テスト通過 | ✅完了 |
| #9 | /summary実装 | 要約生成確認 | ✅完了 |
| #10 | /search実装 | 検索結果返却確認 | ✅完了 |

### Week 4: 統合・テスト

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #11 | 統合Room通知 | 通知送信成功 | ✅完了 |
| #12 | 他AIプロバイダー追加 | Anthropic, Google, Groq | ✅完了 |
| #13 | 統合テスト | 全機能連携確認 | ✅完了 |
| #14 | 試験運用準備 | 1社分のWorkspace構築、複数サーバー実機テスト（#5確認含む） | ✅完了 |

## 4. Issue テンプレート
```markdown
## 概要
何を実装するか

## 完了条件
- [ ] テストが書かれている
- [ ] 実装が完了している
- [ ] 全テスト通過
- [ ] ruff check 通過
- [ ] ドキュメント更新（必要なら）

## 関連ドキュメント
- REQUIREMENTS.md: #{セクション番号}
- ARCHITECTURE.md: #{セクション番号}

## テストケース
- TEST_PLAN.md: {テストID}

## 専門家チェック
- [ ] ソフトウェアエンジニア視点
- [ ] Python視点
- [ ] セキュリティ視点
- [ ] QA視点
```

## 5. PR テンプレート
```markdown
## 対応Issue
closes #XX

## 変更内容
-

## テスト結果
uv run pytest tests/ -v の出力

## 確認事項
- [ ] 全テスト通過
- [ ] ruff check 通過
- [ ] pyright 通過（警告のみ許容）
- [ ] ドキュメント更新（必要なら）
```

## 6. GitHub運用

### ブランチ戦略
```
main              ← 本番（保護）
└── feature/issue-{n}  ← 機能開発
```

### マージルール
- PRは全テスト通過必須
- ruff check通過必須
- セルフマージOK（1人開発のため）

## 7. 進捗の確認方法

### テスト結果で判断
```bash
uv run pytest tests/ -v
```

- `PASSED` が増えている → 順調
- `FAILED` がある → 修正必要

### カバレッジで判断
```bash
uv run pytest tests/ --cov=src
```

- 70%以上 → OK
- 70%未満 → テスト追加

### リントチェック
```bash
uv run ruff check src/
```

- エラー0 → OK
- エラーあり → 修正必要

## 8. 最終ゴールとの対応表

VISION.mdで定義した最終ゴールと、各Phaseでの対応状況:

| 最終ゴール | Phase 1 | Phase 2 | Phase 3 |
|------------|---------|---------|---------|
| G1: 全データ保存 | ✅ テキスト・添付 | 通話録音 | - |
| G2: 検索 | ✅ キーワード | - | ベクトル検索 |
| G3: 資料AI質問 | - | - | RAG |
| G4: リマインド | - | リマインダー | - |
| G5: 分離管理 | ✅ Workspace | - | - |
| G6: AI切替 | ✅ AIRouter | - | - |
| 可用性（24h稼働） | - | Fly.io移行 | - |
| ファイルクラウド化 | - | Google Drive | - |

**結論**: Phase 2で24h稼働+クラウドファイル保存を実現。Phase 3でRAG追加し最終ゴール達成。

## 9. Phase 2 詳細スケジュール

### 方針

1. 技術課題を先に解消（安定性確保）
2. リマインダー実装
3. **クラウド移行（Fly.io）+ Google Drive連携**
4. 通話録音・文字起こし

### Step 1: 技術課題解消

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #15 | datetime.utcnow()修正 | datetime.now(UTC)に置換 | 未着手 |
| #16 | GuildListenerテスト追加 | on_guild_join/removeテスト | 未着手 |
| #17 | レート制限対策 | asyncio.Semaphore/Queue実装 | 未着手 |

### Step 2: リマインダー機能

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #18 | Reminderテーブル | モデル・CRUD完了 | 未着手 |
| #19 | /remind実装 | リマインダー登録 | 未着手 |
| #20 | /reminders実装 | 一覧表示 | 未着手 |
| #21 | 期限通知機能 | 統合Room自動通知 | 未着手 |

### Step 3: クラウド移行（Fly.io）

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #22 | Dockerfile作成 | ローカルでビルド成功 | 未着手 |
| #23 | fly.toml設定 | Fly CLI設定完了 | 未着手 |
| #24 | SQLite Volume対応 | データ永続化確認 | 未着手 |
| #25 | Fly.ioデプロイ | 本番稼働確認 | 未着手 |

### Step 4: Google Drive連携

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #26 | GoogleDriveStorage実装 | StorageProviderインターフェース準拠 | 未着手 |
| #27 | OAuth設定 | 認証フロー完了 | 未着手 |
| #28 | /saveコマンド | 手動アップロード成功 | 未着手 |
| #29 | 自動アップロード | config設定で制御 | 未着手 |

### Step 5: 通話録音・文字起こし

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #30 | VoiceSession実装 | テーブル・CRUD完了 | 未着手 |
| #31 | 通話録音機能 | /record on/off実装 | 未着手 |
| #32 | Whisperプロバイダー | 文字起こしAPI連携 | 未着手 |
| #33 | /transcribe実装 | 文字起こし結果表示 | 未着手 |

### Step 6: 統合・テスト

| Issue | タスク | 完了条件 | 状態 |
|-------|--------|----------|------|
| #34 | Phase 2統合テスト | 全機能連携確認 | 未着手 |
| #35 | 本番運用テスト | 複数社で動作確認 | 未着手 |

## 10. Phase 3 概要

### 目標

「資料にAI質問」(G3) - 自然言語検索と回答生成

### 機能

| Issue | タスク | 内容 | 状態 |
|-------|--------|------|------|
| #36 | Documentテーブル | 資料メタデータ保存 | 未着手 |
| #37 | ベクトル化 | Embeddings保存・検索 | 未着手 |
| #38 | /ask実装 | RAG回答生成 | 未着手 |
| #39 | Phase 3統合テスト | 全機能確認 | 未着手 |

## 11. クラウド移行計画

### 結論

**Fly.io一択**（議論ログより）

### 理由

| 理由 | 詳細 |
|------|------|
| Discord Botと相性◎ | WebSocket常時接続OK、スリープしない |
| Claude Code連携◎ | Dockerfile/fly.tomlをコード管理、AIが修正しやすい |
| 無料枠あり | 常時稼働前提で無料枠を使える |

### 実施タイミング

Phase 2 Step 2（リマインダー）完了後、Step 5（通話録音）の前

### 実施内容

1. Dockerfile作成
2. fly.toml設定
3. Fly.ioデプロイ
4. SQLite→永続化対応（Volume）

## 12. Phase 4 概要（将来）

### 目標

50社対応、スケールアウト

### 機能

| 機能 | 内容 | トリガー |
|------|------|----------|
| Bot分割 | 10サーバー/Bot制限対応 | 10社到達時 |
| PostgreSQL移行 | SQLite→本番DB | クラウド移行時 |
| シャーディング | 2,500サーバー対応 | 将来 |
