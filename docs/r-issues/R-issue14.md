# R-issue14: Discord E2Eテスト自動化の検討

## 要約

Botを起動し、Discordに対してプログラム的に投稿・コマンド実行・結果確認を行う
E2Eテストの自動化について検討する。

## Agent

Codex

## 日付

2026-01-18

---

## 背景

- 手動テストはDiscord上で実施できるが、自動化の要望が出た
- ただしDiscord側の入出力はBotトークンやテスト用Guild/Channelに依存

---

## 検討ポイント

1. 自動化できる範囲
   - REST APIでメッセージ投稿
   - スラッシュコマンド実行
   - 返信内容の取得と検証
2. 必要な前提
   - テスト専用Botトークン
   - テスト専用Guild/Channelの固定
   - 権限/レート制限/同期タイミングの考慮
3. 難しい領域
   - Discord UIの確認
   - VC録音の実機挙動（音声ストリーム依存）

---

## 実装方針（Codex実装予定）

| 優先度 | タスク | ステータス |
|--------|--------|------------|
| P1 | 最小E2Eスクリプト作成 (`tests/e2e/test_discord_e2e.py`) | 未着手 |
| P2 | テスト専用Bot/サーバーの分離運用ドキュメント | 未着手 |
| P3 | CI連携（GitHub Actions） | 将来課題 |

### P1: 最小E2Eスクリプト

- 環境変数: `E2E_BOT_TOKEN`, `E2E_CHANNEL_ID`, `E2E_GUILD_ID`
- フロー:
  1. テストメッセージ投稿（ユニークキーワード付き）
  2. 2秒待機（DB保存待ち）
  3. `/search` 実行（REST APIまたはBot内部呼び出し）
  4. 結果にユニークキーワードが含まれるか検証

### 注意事項

- テスト専用サーバー・チャンネルを使用し、本番環境への影響を防ぐ
- レート制限を考慮し、テスト間に適切な待機時間を設ける

---

## 参考

- `docs/guides/DISCORD_SETUP.md`
