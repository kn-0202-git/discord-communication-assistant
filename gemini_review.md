# Gemini コードレビュー

このドキュメントは、`discord-communication-assistant` プロジェクトに対する、4人の模擬専門家ペルソナによる包括的なコードレビューを含みます。

**日付:** 2026-01-12
**対象:** `src/` および `tests/`
**レビュアー:**
- 🏛️ **リードアーキテクト** (システム設計, スケーラビリティ)
- 🔒 **セキュリティエンジニア** (セキュリティ, プライバシー)
- 🧪 **QAエンジニア** (テスト, 品質)
- 🤖 **AIスペシャリスト** (AI統合, LLM Ops)

---

## 🏛️ リードアーキテクトによるレビュー

### ✅ 良い点
- **クリーンアーキテクチャ:** プロジェクト構成は整理されており、関心の分離が明確です。`src/ai` (ロジック)、`src/bot` (インターフェース)、`src/db` (永続化)、`src/storage` (ファイル操作) が明確に分かれています。
- **モダンなSQLAlchemy:** `src/db/models.py` における SQLAlchemy 2.0 スタイル (`Mapped`, `mapped_column`, `DeclarativeBase`) の使用は素晴らしいです。型安全性と可読性が向上しています。
- **設定可能なAIルーティング:** `AIRouter` の設計 (`src/ai/router.py`) はハイライトであり、カスケード式の設定 (Room > Workspace > Global) を可能にしています。これにより、Botのマルチテナント/マルチコンテキストな性質を効果的にサポートしています。
- **ストレージの抽象化:** `LocalStorage` の実装は、ファイル操作をファサードの背後に置くことで、将来の拡張（S3やGCSなど）を見越しています。

### ⚠️ 改善が必要な点
1. **サービス層パターン:**
   - 現在、`MessageHandler` (`src/bot/handlers.py`) には、オーケストレーションロジックとビジネスロジック（例：メッセージタイプの判定、ファイルダウンロード管理）が混在しています。
   - **推奨事項:** ビジネスロジック（msg -> db, msg -> storage, msg -> ai）を処理する `MessageService` を抽出して、`MessageHandler` は Discord 固有のイベントのみに関心を持つようにしてください。

2. **HTTPセッション管理:**
   - `src/bot/handlers.py` の `_save_attachments` では、添付ファイル付きのメッセージごとに新しい `aiohttp.ClientSession` を作成しています。
   - **推奨事項:** 接続プーリングとより良いリソース管理のために、`BotClient` または `main.py` から共有の `aiohttp.ClientSession` を渡すようにしてください。

3. **エントリーポイントの複雑さ:**
   - `src/main.py` が多くのことを行いすぎています: 設定読み込み、DB初期化、ストレージ初期化、ルーター初期化、Botセットアップ、スラッシュコマンド同期。
   - **推奨事項:** `Bootstrap` クラスまたは `create_app()` ファクトリ関数を作成して、グローバル名前空間を整理し、テスト容易性を向上させてください。

4. **型安全性:**
   - `discord.py` のイベントハンドラで `Any` や `# type: ignore` が一部使用されています。
   - **推奨事項:** `discord.py` の型が不十分な場合は、無視するのではなく、Discord イベントペイロード用の厳密な TypedDict または Data Class を定義してください。

---

## 🔒 セキュリティエンジニアによるレビュー

### ✅ 良い点
- **機密情報管理:** 機密トークン (`DISCORD_TOKEN`, APIキー) に対する `.env` の使用は適切です。
- **DoS保護:** `MessageHandler` (`MAX_ATTACHMENT_SIZE` と `Content-Length` チェック) におけるファイルサイズの明示的なチェックにより、ディスク埋め尽くし攻撃を防いでいます。
- **Workspace分離:** データベーススキーマ (`src/db/models.py`) は、論理的にデータを `Workspace` ごとに分離しています。

### ⚠️ 改善が必要な点
1. **ハードコードされた制限:**
   - `MAX_ATTACHMENT_SIZE = 25 * 1024 * 1024` がクラス内にハードコードされています。
   - **推奨事項:** これを環境変数または `config.yaml` に移動し、コード変更なしで迅速に調整できるようにしてください（例：サーバーブーストレベルが変更された場合など）。

2. **データベースマイグレーション:**
   - `db.create_tables()` が起動ごとに実行されます。これは本番データベースにとってリスクがあります。
   - **推奨事項:** 適切なスキーママイグレーションのバージョニングのために `alembic` を統合してください。本番環境では `Base.metadata.create_all` に依存しないでください。

3. **Googleプロバイダーのグローバル状態:**
   - `genai.configure(api_key=api_key)` はモジュールをグローバルに設定します。
   - **推奨事項:** 同じプロセス内で異なるワークスペースに全く異なるAPIキーをサポートする必要ができた場合（このスコープでは稀でしょうが）に競合しないようにしてください。

---

## 🧪 QAエンジニアによるレビュー

### ✅ 良い点
- **統合テスト:** `tests/test_integration.py` は重要なユーザーフロー（メッセージフロー、通知フロー）をカバーしています。
- **テストインフラ:** データベースとオブジェクトのライフサイクル管理に `pytest` フィクスチャをうまく活用しています。
- **インメモリロジック:** `sqlite:///:memory:` を使用することで、テストが高速かつ隔離されています。

### ⚠️ 改善が必要な点
1. **モック戦略:**
   - `spec` 引数なしでの `MagicMock` の広範な使用。
   - **推奨事項:** APIシグネチャが変更された場合にテストが確実に失敗するように、外部ライブラリ（Discord, OpenAI）をモックする際は `autospec=True` または `spec=Class` を使用してください。

2. **ルーターテスト:**
   - `test_ai_router_with_providers` はルーター *および* プロバイダーのインスタンス化をテストしています。
   - **推奨事項:** プロバイダー自体の動作確認を厳密に必要とせず、*選択ロジック* だけを検証する、より粒度の細かい `AIRouter` のユニットテストを追加してください（例：設定を大幅にモックする）。

3. **エッジケース:**
   - テストが「ハッピーパス（正常系）」に焦点を当てています。
   - **推奨事項:** 以下のテストケースを追加してください：
     - データベース接続エラー。
     - 無効な拡張子や0バイトのファイル。
     - APIレート制限（`AIQuotaExceededError` のシミュレーション）。

---

## 🤖 AIスペシャリストによるレビュー

### ✅ 良い点
- **マルチプロバイダーサポート:** 優れた抽象化である `AIProvider` ベースクラスにより、OpenAI、Gemini などの間の切り替えが容易です。
- **ベクトル埋め込みサポート:** アーキテクチャが埋め込みをファーストクラス市民として扱っており（`embed` メソッド）、RAG の基礎が整っています。

### ⚠️ 改善が必要な点
1. **トークン管理:**
   - `generate_with_context` は単純に文字列を連結しています (`context_text = "\n".join(...)`)。
   - **推奨事項:** `TokenCounter` ユーティリティを実装してください。コンテキストがモデルのウィンドウを超えた場合、古いメッセージをトリミングまたは要約する必要があります。現状では、履歴が長すぎると API コールがクラッシュします。

2. **プロンプト管理:**
   - プロンプトがコード内で f-string を介して構築されています。
   - **推奨事項:** システムプロンプトとテンプレート文字列を外部のテキスト/YAMLファイルまたは `PromptManager` クラスに移動してください。これにより、エンジニア以外（またはあなた）が Python コードに触れることなくプロンプトを改善できます。

3. **コンテキストフォーマット:**
   - コンテキストのフォーマットが一般的です (`role: content`)。
   - **推奨事項:** 一部のモデル（Claude/Anthropicなど）は、`User` 対 `Assistant` の交互の役割を厳密に強制します。必要に応じて、同じ役割からの連続したメッセージをマージするように、プロバイダーに渡す `context` リストをサニタイズしてください。

---

## 次のステップのまとめ

1. **`src/main.py` のリファクタリング:** 初期化ロジックを整理する。
2. **`alembic` の導入:** データベースマイグレーション用。
3. **`MessageHandler` の強化:** 共有 `aiohttp` セッションを使用するようにする。
4. **トークンカウントの実装:** AIプロバイダー内でコンテキストウィンドウのオーバーフローを防ぐ。
5. **プロンプトの抽出:** 専用の管理システムへ移行する。
